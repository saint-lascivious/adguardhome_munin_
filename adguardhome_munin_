#!/usr/bin/env sh

#          _                       _ _                                 _
#  __ _ __| |__ _ _  _ __ _ _ _ __| | |_  ___ _ __  ___ _ __ _  _ _ _ (_)_ _
# / _` / _` / _` | || / _` | '_/ _` | ' \/ _ \ '  \/ -_) '  \ || | ' \| | ' \
# \__,_\__,_\__, |\_,_\__,_|_| \__,_|_||_\___/_|_|_\___|_|_|_\_,_|_||_|_|_||_|
#           |___/

# saint-lascivious (Hayden Pearce), 2025

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

set -e

case "${0}" in
    /*)
        script_path="${0}"
    ;;
    *)
        script_path="$(cd "$(dirname "${0}")" && pwd)/$(basename "${0}")"
    ;;
esac

adguardhome_munin_plugin_id="$(printf "%s" "${script_path}" | sed -e 's/^.*adguardhome_munin_//')"

if [ -z "${adguardhome_munin_plugin_id}" ]; then
    adguardhome_munin_plugin_id="percent"
fi

adguardhome_munin_plugins="blocked clients domains percent processing queries status upstreams upstreams_avg"

pref="${proto:-"https"}"
host="${host:-"localhost"}"
port="${port:-"443"}"

api="${pref}://${host}:${port}"

top_n="${top_n:-"10"}"

if [ "${top_n}" -gt "100" ]; then
    top_n="100"
fi

user="${username:-}"
pass="${password:-}"

graph="${graph:-"yes"}"
graph_args="${graph_args:-"--lower-limit 0"}"
graph_category="${graph_category:-"dns"}"
graph_draw="${graph_draw:-"LINE1"}"
graph_height="${graph_height:-"200"}"
graph_scale="${graph_scale:-"no"}"
graph_type="${graph_type:-"GAUGE"}"
graph_width="${graph_width:-"400"}"

state_dir=${MUNIN_PLUGSTATE:-"/tmp/adguardhome_munin_"}
state_file="${state_dir}/${adguardhome_munin_plugin_id}.state"

mkdir -p "${state_dir}"

cookie_file=$(mktemp "${state_dir}/cookie_file.XXXXXX" 2>/dev/null || mktemp -t cookie_file.XXXXXX)

trap 'rm -f "${cookie_file}"' EXIT

adguardhome_munin_print() {
    if ! printf %s "${1}" | grep -Eq '^[a-zA-Z_][a-zA-Z0-9_]*$'; then
        printf "%s\n" "Error: Invalid or missing key." >&2
        exit 1
    fi
    if [ -z "${7}" ] || printf %s "${7}" | grep -q '[#\\]'; then
        printf "%s\n" "Error: Invalid or missing label." >&2
        exit 1
    fi
    if [ -n "${2}" ] && [ -n "$(printf '%s' "${2}" | tr -d '[:space:]')" ]; then
        colour_val="${2#\#}"
        if printf %s "${colour_val}" | grep -Eq '^[0-9A-Fa-f]{3}$'; then
            r=$(printf %s "${colour_val}" | cut -c1)
            g=$(printf %s "${colour_val}" | cut -c2)
            b=$(printf %s "${colour_val}" | cut -c3)
            colour_val="${r}${r}${g}${g}${b}${b}"
        fi
        if printf %s "${colour_val}" | grep -Eq '^[0-9A-Fa-f]{6}$'; then
            printf "%s.colour %s\n" "${1}" "${colour_val}"
        fi
    fi
    if [ -n "${3}" ] && [ -n "$(printf '%s' "${3}" | tr -d '[:space:]')" ]; then
        if printf %s "${3}" | grep -Eq '^(-?[0-9]+(\.[0-9]*)?)?(:(-?[0-9]+(\.[0-9]*)?)?)?$|^(-?[0-9]+(\.[0-9]*)?):$'; then
            printf "%s.critical %s\n" "${1}" "${3}"
        fi
    fi
    if [ -n "${4}" ] && [ -n "$(printf '%s' "${4}" | tr -d '[:space:]')" ]; then
        if printf %s "${4}" | grep -Eq '^LINE[0-9]*$|^AREA$|^STACK$|^AREASTACK$|^LINESTACK[0-9]*$'; then
            printf "%s.draw %s\n" "${1}" "${4}"
        fi
    fi
    if [ -n "${5}" ] && [ -n "$(printf '%s' "${5}" | tr -d '[:space:]')" ]; then
        case "${5}" in
            "yes"|"no")
                printf "%s.graph %s\n" "${1}" "${5}"
            ;;
        esac
    fi
    if [ -n "${6}" ] && [ -n "$(printf '%s' "${6}" | tr -d '[:space:]')" ]; then
        printf "%s.info %s\n" "${1}" "${6}"
    fi
    printf "%s.label %s\n" "${1}" "${7}"
    if [ -n "${8}" ] && [ -n "$(printf '%s' "${8}" | tr -d '[:space:]')" ]; then
        if printf %s "${8}" | grep -Eq '^(-?[0-9]+(\.[0-9]*)?)$'; then
            printf "%s.max %s\n" "${1}" "${8}"
        fi
    fi
    if [ -n "${9}" ] && [ -n "$(printf '%s' "${9}" | tr -d '[:space:]')" ]; then
        if printf %s "${9}" | grep -Eq '^(-?[0-9]+(\.[0-9]*)?)$'; then
            printf "%s.min %s\n" "${1}" "${9}"
        fi
    fi
    if [ -n "${10}" ] && [ -n "$(printf '%s' "${10}" | tr -d '[:space:]')" ]; then
        case "${10}" in
            "GAUGE"|"COUNTER"|"DERIVE"|"ABSOLUTE")
                printf "%s.type %s\n" "${1}" "${10}"
            ;;
        esac
    fi
    if [ -n "${11}" ] && [ -n "$(printf '%s' "${11}" | tr -d '[:space:]')" ]; then
        if printf %s "${11}" | grep -Eq '^(-?[0-9]+(\.[0-9]*)?)?(:(-?[0-9]+(\.[0-9]*)?)?)?$|^(-?[0-9]+(\.[0-9]*)?):$'; then
            printf "%s.warning %s\n" "${1}" "${11}"
        fi
    fi
}

adguardhome_munin_print_state_keys() {
    if [ -s "${1}" ]; then
        while IFS= read -r key; do
            adguardhome_munin_print \
                "${key}" \
                "${2}" \
                "${3}" \
                "${4}" \
                "${5}" \
                "${6}" \
                "${7}" \
                "${8}" \
                "${9}" \
                "${10}" \
                "${11}"
        done < "${1}"
    else
        adguardhome_munin_print \
            "none" \
            "" \
            "" \
            "${4}" \
            "${5}" \
            "${12}" \
            "${13}" \
            "" \
            "${9}" \
            "${10}" \
            ""
    fi
}

adguardhome_munin_auth() {
    response=$(curl --connect-timeout 5 -k -s -L \
        -H "Content-Type: application/json" \
        -c "${cookie_file}" \
        -d "{\"name\":\"${user}\",\"password\":\"${pass}\"}" \
        -w "\n%{http_code}" \
        "${api}/control/login")
    http_code=$(printf "%s" "${response}" | tail -n1)
    case "${http_code}" in
        "200")
            return 0
            ;;
        "400")
            printf "Error: Invalid username/password..\n" >&2
            return 1
            ;;
        "429")
            printf "Error: Out of login attempts.\n" >&2
            return 1
            ;;
        *)
            printf "Error: Unexpected HTTP response from AdGuardHome API (login): %s\n" "${http_code}" >&2
            return 1
            ;;
    esac
}

adguardhome_munin_logout() {
    response=$(curl --connect-timeout 5 -k -s -L \
        -H "Content-Type: application/json" \
        -b "${cookie_file}" \
        -w "\n%{http_code}" \
        "${api}/control/logout")
    http_code=$(printf "%s" "${response}" | tail -n1)
    rm -f "${cookie_file}"
    case "${http_code}" in
        "200")
            return 0
            ;;
        *)
            printf "%s\n" "Error: Unexpected HTTP response from AdGuardHome API (logout): ${http_code}" >&2
            return 1
            ;;
    esac
}

adguardhome_munin_config_blocked() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows the top ${top_n} AdGuardHome blocked domains" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome top ${top_n} blocked domains" \
        "graph_vlabel queries" \
        "graph_width ${graph_width}"
    blocked_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/blocked_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "blocked_keys_tmp.XXXXXX")
    printf "%s\n" "${blocked_response}" | jq -r ".top_blocked_domains[:${top_n}][] | to_entries[] | \"\(.key)\"" | \
    while read -r blocked_domain; do
        blocked_key=$(printf "%s" "${blocked_domain}" | tr -c 'a-zA-Z0-9' '_')
        case "${blocked_key}" in
            [0-9]*)
                blocked_key="blocked_${blocked_key}"
                ;;
        esac
        printf "%s\n" "${blocked_key}" >> "${tmp_keys_file}"
        if [ "${#blocked_domain}" -gt 19 ]; then
            label="$(printf "%s" "${blocked_domain}" | cut -c1-16)..."
        else
            label="${blocked_domain}"
        fi
        adguardhome_munin_print \
            "${blocked_key}" \
            "" \
            "" \
            "${graph_draw}" \
            "yes" \
            "${blocked_domain}" \
            "${label}" \
            "" \
            "0" \
            "${graph_type}" \
            ""
    done
    if [ -s "${tmp_keys_file}" ]; then
        if [ -f "${state_file}" ]; then
            cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
            mv "${tmp_keys_file}.merged" "${state_file}"
        else
            mv "${tmp_keys_file}" "${state_file}"
        fi
    fi
    rm -f "${tmp_keys_file}"
    adguardhome_munin_print_state_keys \
        "${state_file}" \
        "" \
        "" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome blocked domains" \
        "blocked" \
        "" \
        "0" \
        "${graph_type}" \
        "" \
        "No blocked domains" \
        "none"
}

adguardhome_munin_fetch_blocked() {
    blocked_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/blocked_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "blocked_keys_tmp.XXXXXX")
    tmp_output_file=$(mktemp "${state_dir}/blocked_output_tmp.XXXXXX" 2>/dev/null || mktemp -t "blocked_output_tmp.XXXXXX")
    printf "%s\n" "${blocked_response}" | jq -r ".top_blocked_domains[:${top_n}][] | to_entries[] | \"\(.key) \(.value)\"" | \
    while read -r blocked_domain num_blocked; do
        blocked_key=$(printf "%s" "${blocked_domain}" | tr -c 'a-zA-Z0-9' '_')
        case "${blocked_key}" in
            [0-9]*)
                blocked_key="blocked_${blocked_key}"
                ;;
        esac
        printf "%s\n" "${blocked_key}" >> "${tmp_keys_file}"
        printf "%s.value %s\n" "${blocked_key}" "${num_blocked}" >> "${tmp_output_file}"
    done
    if [ -f "${state_file}" ]; then
        cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
        mv "${tmp_keys_file}.merged" "${state_file}"
        rm -f "${tmp_keys_file}"
    else
        mv "${tmp_keys_file}" "${state_file}"
    fi
    all_keys=$(cat "${state_file}")
    if [ -z "${all_keys}" ]; then
        printf "none.value 0\n"
        rm -f "${tmp_output_file}"
        return
    fi
    for key in ${all_keys}; do
        grep -qx "${key}" "${state_file}"
        if grep -qx "${key}" "${tmp_keys_file}"; then
            grep "^${key}\.value " "${tmp_output_file}" || printf "%s.value U\n" "${key}"
        else
            printf "%s.value U\n" "${key}"
        fi
    done
    rm -f "${tmp_output_file}"
}

adguardhome_munin_config_clients() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows the top ${top_n} AdGuardHome clients" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome top ${top_n} clients" \
        "graph_vlabel queries" \
        "graph_width ${graph_width}"
    clients_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/clients_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "clients_keys_tmp.XXXXXX")
    printf "%s\n" "${clients_response}" | jq -r ".top_clients[:${top_n}][] | to_entries[] | \"\(.key)\"" | \
    while read -r client; do
        clients_key=$(printf "%s" "${client}" | tr -c 'a-zA-Z0-9' '_')
        case "${clients_key}" in
            [0-9]*)
                clients_key="client_${clients_key}"
                ;;
        esac
        printf "%s\n" "${clients_key}" >> "${tmp_keys_file}"
        if [ "${#client}" -gt 19 ]; then
            label="$(printf "%s" "${client}" | cut -c1-16)..."
        else
            label="${client}"
        fi
        adguardhome_munin_print \
            "${clients_key}" \
            "" \
            "100000" \
            "${graph_draw}" \
            "yes" \
            "${client}" \
            "${label}" \
            "" \
            "0" \
            "${graph_type}" \
            "0:50000"
    done
    if [ -s "${tmp_keys_file}" ]; then
        if [ -f "${state_file}" ]; then
            cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
            mv "${tmp_keys_file}.merged" "${state_file}"
        else
            mv "${tmp_keys_file}" "${state_file}"
        fi
    fi
    rm -f "${tmp_keys_file}"
    adguardhome_munin_print_state_keys \
        "${state_file}" \
        "" \
        "100000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome clients" \
        "client" \
        "" \
        "0" \
        "${graph_type}" \
        "0:50000" \
        "No clients" \
        "none"
}

adguardhome_munin_fetch_clients() {
    clients_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/clients_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "clients_keys_tmp.XXXXXX")
    tmp_output_file=$(mktemp "${state_dir}/clients_output_tmp.XXXXXX" 2>/dev/null || mktemp -t "clients_output_tmp.XXXXXX")
    printf "%s\n" "${clients_response}" | jq -r ".top_clients[:${top_n}][] | to_entries[] | \"\(.key) \(.value)\"" | \
    while read -r client num_queries; do
        clients_key=$(printf "%s" "${client}" | tr -c 'a-zA-Z0-9' '_')
        case "${clients_key}" in
            [0-9]*)
                clients_key="client_${clients_key}"
                ;;
        esac
        printf "%s\n" "${clients_key}" >> "${tmp_keys_file}"
        printf "%s.value %s\n" "${clients_key}" "${num_queries}" >> "${tmp_output_file}"
    done
    if [ -f "${state_file}" ]; then
        cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
        mv "${tmp_keys_file}.merged" "${state_file}"
    else
        mv "${tmp_keys_file}" "${state_file}"
    fi
    all_keys=$(cat "${state_file}")
    if [ -z "${all_keys}" ]; then
        printf "none.value 0\n"
        rm -f "${tmp_output_file}"
        return
    fi
    for key in ${all_keys}; do
        if grep -qxF "${key}" "${tmp_keys_file}"; then
            grep "^${key}\.value " "${tmp_output_file}" || printf "%s.value U\n" "${key}"
        else
            printf "%s.value U\n" "${key}"
        fi
    done
    rm -f "${tmp_keys_file}" "${tmp_output_file}"
}

adguardhome_munin_config_domains() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows the top ${top_n} AdGuardHome domains" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome top ${top_n} domains" \
        "graph_vlabel queries" \
        "graph_width ${graph_width}"
    domains_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/domains_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "domains_keys_tmp.XXXXXX")
    printf "%s\n" "${domains_response}" | jq -r ".top_queried_domains[:${top_n}][] | to_entries[] | \"\(.key)\"" | \
    while read -r domain; do
        domains_key=$(printf "%s" "${domain}" | tr -c 'a-zA-Z0-9' '_')
        case "${domains_key}" in
            [0-9]*)
                domains_key="domain_${domains_key}"
                ;;
        esac
        printf "%s\n" "${domains_key}" >> "${tmp_keys_file}"
        if [ "${#domain}" -gt 19 ]; then
            label="$(printf "%s" "${domain}" | cut -c1-16)..."
        else
            label="${domain}"
        fi
        adguardhome_munin_print \
            "${domains_key}" \
            "" \
            "100000" \
            "${graph_draw}" \
            "yes" \
            "${domain}" \
            "${label}" \
            "" \
            "0" \
            "${graph_type}" \
            "0:50000"
    done
    adguardhome_munin_print_state_keys \
    "${state_file}" \
    "" \
    "100000" \
    "${graph_draw}" \
    "yes" \
    "" \
    "" \
    "" \
    "0" \
    "${graph_type}" \
    "0:50000" \
    "No domains" \
    "none"
}

adguardhome_munin_fetch_domains() {
    domains_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/domains_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "domains_keys_tmp.XXXXXX")
    tmp_output_file=$(mktemp "${state_dir}/domains_output_tmp.XXXXXX" 2>/dev/null || mktemp -t "domains_output_tmp.XXXXXX")
    printf "%s\n" "${domains_response}" | jq -r ".top_queried_domains[:${top_n}][] | to_entries[] | \"\(.key) \(.value)\"" | \
    while read -r domain num_queries; do
        domains_key=$(printf "%s" "${domain}" | tr -c 'a-zA-Z0-9' '_')
        case "${domains_key}" in
            [0-9]*)
                domains_key="domain_${domains_key}"
                ;;
        esac
        printf "%s\n" "${domains_key}" >> "${tmp_keys_file}"
        printf "%s.value %s\n" "${domains_key}" "${num_queries}" >> "${tmp_output_file}"
    done
    if [ -f "${state_file}" ]; then
        cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
        mv "${tmp_keys_file}.merged" "${state_file}"
    else
        mv "${tmp_keys_file}" "${state_file}"
    fi
    all_keys=$(cat "${state_file}")
    if [ -z "${all_keys}" ]; then
        printf "none.value 0\n"
        rm -f "${tmp_output_file}"
        return
    fi
    for key in ${all_keys}; do
        if grep -qxF "${key}" "${tmp_keys_file}"; then
            grep "^${key}\.value " "${tmp_output_file}" || printf "%s.value U\n" "${key}"
        else
            printf "%s.value U\n" "${key}"
        fi
    done
    rm -f "${tmp_keys_file}" "${tmp_output_file}"
}

adguardhome_munin_config_percent() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args --upper-limit 100 --lower-limit 0" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows AdGuardHome's blocked query percentage" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome percent blocked" \
        "graph_vlabel percent blocked" \
        "graph_width ${graph_width}"
    adguardhome_munin_print \
        "percent_blocked" \
        "" \
        "90" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome percent blocked" \
        "percent blocked" \
        "100" \
        "0" \
        "${graph_type}" \
        "0:75"
}

adguardhome_munin_fetch_percent() {
    percent_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    if [ -z "${percent_response}" ]; then
        printf "percent_blocked.value U\n"
        return
    fi
    num_dns_queries=$(printf "%s" "${percent_response}" | jq -r '.num_dns_queries')
    num_blocked_filtering=$(printf "%s" "${percent_response}" | jq -r '.num_blocked_filtering')
    if [ -z "${num_dns_queries}" ] || [ "${num_dns_queries}" -eq "0" ]; then
        percent_blocked="0"
    else
        percent_blocked=$(awk "BEGIN { printf \"%.2f\", (${num_blocked_filtering}/${num_dns_queries})*100 }")
    fi
    printf "percent_blocked.value %s\n" "${percent_blocked}"
}

adguardhome_munin_config_processing() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows AdGuardHome's average DNS processing time" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome average processing time" \
        "graph_vlabel seconds" \
        "graph_width ${graph_width}"
    adguardhome_munin_print \
        "avg_processing_time" \
        "" \
        "" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome average processing time" \
        "avg processing time" \
        "" \
        "0" \
        "${graph_type}" \
        ""
}

adguardhome_munin_fetch_processing() {
    avg_processing_time=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats" \
        | jq -r '.avg_processing_time' \
        | awk -F. '{ printf "%d.%s\n", $1, substr($2 "000", 1, 3) }' \
        | sed 's/\.0*$//;s/\(\.[0-9]*[1-9]\)0*$/\1/')
    if [ -z "${avg_processing_time}" ]; then
        printf "avg_processing_time.value U\n"
        return
    fi
    printf "avg_processing_time.value %s\n" "${avg_processing_time}"
}

adguardhome_munin_config_queries() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows AdGuardHome's DNS query statistics" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome queries" \
        "graph_vlabel queries" \
        "graph_width ${graph_width}"
    adguardhome_munin_print \
        "num_dns_queries" \
        "" \
        "200000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome DNS queries" \
        "num DNS queries" \
        "" \
        "0" \
        "${graph_type}" \
        "0:100000"
    adguardhome_munin_print \
        "num_blocked_filtering" \
        "" \
        "100000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome blocked filtering" \
        "num blocked filtering" \
        "" \
        "0" \
        "${graph_type}" \
        "0:50000"
    adguardhome_munin_print \
        "num_replaced_safebrowsing" \
        "" \
        "100000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome replaced safebrowsing" \
        "num replaced safebrowsing" \
        "" \
        "0" \
        "${graph_type}" \
        "0:50000"
    adguardhome_munin_print \
        "num_replaced_parental" \
        "" \
        "100000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome replaced parental" \
        "num replaced parental" \
        "" \
        "0" \
        "${graph_type}" \
        "0:50000"
    adguardhome_munin_print \
        "num_replaced_safesearch" \
        "" \
        "100000" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome replaced safesearch" \
        "num replaced safesearch" \
        "" \
        "0" \
        "${graph_type}" \
        "0:50000"
}

adguardhome_munin_fetch_queries() {
    queries_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    if [ -z "${queries_response}" ]; then
        printf "num_dns_queries.value U\n"
        printf "num_blocked_filtering.value U\n"
        printf "num_replaced_safebrowsing.value U\n"
        printf "num_replaced_parental.value U\n"
        printf "num_replaced_safesearch.value U\n"
        return
    fi
    num_dns_queries=$(printf "%s" "${queries_response}" | jq -r '.num_dns_queries')
    num_blocked_filtering=$(printf "%s" "${queries_response}" | jq -r '.num_blocked_filtering')
    num_replaced_safebrowsing=$(printf "%s" "${queries_response}" | jq -r '.num_replaced_safebrowsing')
    num_replaced_parental=$(printf "%s" "${queries_response}" | jq -r '.num_replaced_parental')
    num_replaced_safesearch=$(printf "%s" "${queries_response}" | jq -r '.num_replaced_safesearch')
    printf "num_dns_queries.value %s\n" "${num_dns_queries:-0}"
    printf "num_blocked_filtering.value %s\n" "${num_blocked_filtering:-0}"
    printf "num_replaced_safebrowsing.value %s\n" "${num_replaced_safebrowsing:-0}"
    printf "num_replaced_parental.value %s\n" "${num_replaced_parental:-0}"
    printf "num_replaced_safesearch.value %s\n" "${num_replaced_safesearch:-0}"
}

adguardhome_munin_config_status() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args --lower-limit -1 --upper-limit 1" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows AdGuardHome's protection status" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome status" \
        "graph_vlabel unknown / disabled / enabled" \
        "graph_width ${graph_width}"
    adguardhome_munin_print \
        "protection_status" \
        "" \
        "0:1" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome protection status" \
        "protection status" \
        "" \
        "-1" \
        "1" \
        "${graph_type}" \
        "1:1"
}

adguardhome_munin_fetch_status() {
    status_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/status")
    protection_enabled=$(printf "%s" "${status_response}" | jq -r '.protection_enabled')
    case "${protection_enabled}" in
        "true")
            status_value="1"
            ;;
        "false")
            status_value="0"
            ;;
        *)
            status_value="-1"
            ;;
    esac
    printf "protection_status.value %s\n" "${status_value}"
}

adguardhome_munin_config_upstreams() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows the top ${top_n} AdGuardHome upstreams" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome top ${top_n} upstreams" \
        "graph_vlabel queries" \
        "graph_width ${graph_width}"
    upstreams_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/upstreams_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_keys_tmp.XXXXXX")
    printf "%s\n" "${upstreams_response}" | jq -r ".top_upstreams_responses[:${top_n}][] | to_entries[] | \"\(.key)\"" | \
    while read -r upstream; do
        upstreams_key=$(printf "%s" "${upstream}" | tr -c 'a-zA-Z0-9' '_')
        case "${upstreams_key}" in
            [0-9]*)
                upstreams_key="upstreams_${upstreams_key}"
                ;;
        esac
        printf "%s\n" "${upstreams_key}" >> "${tmp_keys_file}"
        if [ "${#upstream}" -gt 19 ]; then
            label="$(printf "%s" "${upstream}" | cut -c1-16)..."
        else
            label="${upstream}"
        fi
        adguardhome_munin_print \
            "${upstreams_key}" \
            "" \
            "" \
            "${graph_draw}" \
            "yes" \
            "${upstream}" \
            "${label}" \
            "" \
            "0" \
            "${graph_type}" \
            ""
    done
    if [ -s "${tmp_keys_file}" ]; then
        if [ -f "${state_file}" ]; then
            cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
            mv "${tmp_keys_file}.merged" "${state_file}"
        else
            mv "${tmp_keys_file}" "${state_file}"
        fi
    fi
    rm -f "${tmp_keys_file}"
    adguardhome_munin_print_state_keys \
        "${state_file}" \
        "" \
        "" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome upstreams" \
        "upstreams" \
        "" \
        "0" \
        "${graph_type}" \
        "" \
        "No upstreams" \
        "none"
}

adguardhome_munin_fetch_upstreams() {
    upstreams_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/upstreams_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_keys_tmp.XXXXXX")
    tmp_output_file=$(mktemp "${state_dir}/upstreams_output_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_output_tmp.XXXXXX")
    printf "%s\n" "${upstreams_response}" | jq -r ".top_upstreams_responses[:${top_n}][] | to_entries[] | \"\(.key) \(.value)\"" | \
    while read -r upstream num_responses; do
        upstreams_key=$(printf "%s" "${upstream}" | tr -c 'a-zA-Z0-9' '_')
        case "${upstreams_key}" in
            [0-9]*)
                upstreams_key="upstreams_${upstreams_key}"
                ;;
        esac
        printf "%s\n" "${upstreams_key}" >> "${tmp_keys_file}"
        printf "%s.value %s\n" "${upstreams_key}" "${num_responses}" >> "${tmp_output_file}"
    done
    if [ -f "${state_file}" ]; then
        cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
        mv "${tmp_keys_file}.merged" "${state_file}"
    else
        mv "${tmp_keys_file}" "${state_file}"
    fi
    all_keys=$(cat "${state_file}")
    if [ -z "${all_keys}" ]; then
        printf "none.value 0\n"
        rm -f "${tmp_output_file}"
        return
    fi
    for key in ${all_keys}; do
        if grep -qxF "${key}" "${tmp_keys_file}"; then
            grep "^${key}\.value " "${tmp_output_file}" || printf "%s.value U\n" "${key}"
        else
            printf "%s.value U\n" "${key}"
        fi
    done
    rm -f "${tmp_keys_file}" "${tmp_output_file}"
}

adguardhome_munin_config_upstreams_avg() {
    printf "%s\n" \
        "graph ${graph}" \
        "graph_args ${graph_args}" \
        "graph_category ${graph_category}" \
        "graph_height ${graph_height}" \
        "graph_info This graph shows average response time for top AdGuardHome upstreams" \
        "graph_scale ${graph_scale}" \
        "graph_title AdGuardHome average upstream response time" \
        "graph_vlabel seconds" \
        "graph_width ${graph_width}"
    upstreams_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/upstreams_avg_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_avg_keys_tmp.XXXXXX")
    printf "%s\n" "${upstreams_response}" | jq -r ".top_upstreams_avg_time[:${top_n}][] | to_entries[] | \"\(.key)\"" | \
    while read -r upstream; do
        upstreams_avg_key=$(printf "%s" "${upstream}" | tr -c 'a-zA-Z0-9' '_')
        case "${upstreams_avg_key}" in
            [0-9]*)
                upstreams_avg_key="upstreams_avg_${upstreams_avg_key}"
                ;;
        esac
        printf "%s\n" "${upstreams_avg_key}" >> "${tmp_keys_file}"
        if [ "${#upstream}" -gt 19 ]; then
            label="$(printf "%s" "${upstream}" | cut -c1-16)..."
        else
            label="${upstream}"
        fi
        adguardhome_munin_print \
            "${upstreams_avg_key}" \
            "" \
            "" \
            "${graph_draw}" \
            "yes" \
            "${upstream}" \
            "${label}" \
            "" \
            "0" \
            "${graph_type}" \
            ""
    done
    if [ -s "${tmp_keys_file}" ]; then
        if [ -f "${state_file}" ]; then
            cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
            mv "${tmp_keys_file}.merged" "${state_file}"
        else
            mv "${tmp_keys_file}" "${state_file}"
        fi
    fi
    rm -f "${tmp_keys_file}"
    adguardhome_munin_print_state_keys \
        "${state_file}" \
        "" \
        "" \
        "${graph_draw}" \
        "yes" \
        "AdGuardHome upstreams average response time" \
        "upstreams_avg" \
        "" \
        "0" \
        "${graph_type}" \
        "" \
        "No upstreams" \
        "none"
}

adguardhome_munin_fetch_upstreams_avg() {
    upstreams_response=$(curl --connect-timeout 5 -k -s -L -b "${cookie_file}" "${api}/control/stats")
    tmp_keys_file=$(mktemp "${state_dir}/upstreams_avg_keys_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_avg_keys_tmp.XXXXXX")
    tmp_output_file=$(mktemp "${state_dir}/upstreams_avg_output_tmp.XXXXXX" 2>/dev/null || mktemp -t "upstreams_avg_output_tmp.XXXXXX")
    printf "%s\n" "${upstreams_response}" | jq -r ".top_upstreams_avg_time[:${top_n}][] | to_entries[] | \"\(.key) \(.value)\"" | \
    while read -r upstream avg_time; do
        upstreams_avg_key=$(printf "%s" "${upstream}" | tr -c 'a-zA-Z0-9' '_')
        case "${upstreams_avg_key}" in
            [0-9]*)
                upstreams_avg_key="upstreams_avg_${upstreams_avg_key}"
                ;;
        esac
        upstreams_avg_time=$(printf "%s" "${avg_time}" | awk -F. '{ printf "%d.%s\n", $1, substr($2 "000", 1, 3) }' | sed 's/\.0*$//;s/\(\.[0-9]*[1-9]\)0*$/\1/')
        printf "%s\n" "${upstreams_avg_key}" >> "${tmp_keys_file}"
        printf "%s.value %s\n" "${upstreams_avg_key}" "${upstreams_avg_time}" >> "${tmp_output_file}"
    done
    if [ -f "${state_file}" ]; then
        cat "${state_file}" "${tmp_keys_file}" | sort -u > "${tmp_keys_file}.merged"
        mv "${tmp_keys_file}.merged" "${state_file}"
    else
        mv "${tmp_keys_file}" "${state_file}"
    fi
    all_keys=$(cat "${state_file}")
    if [ -z "${all_keys}" ]; then
        printf "none.value 0\n"
        rm -f "${tmp_output_file}"
        return
    fi
    for key in ${all_keys}; do
        if grep -qxF "${key}" "${tmp_keys_file}"; then
            grep "^${key}\.value " "${tmp_output_file}" || printf "%s.value U\n" "${key}"
        else
            printf "%s.value U\n" "${key}"
        fi
    done
    rm -f "${tmp_keys_file}" "${tmp_output_file}"
}

adguardhome_munin_fetch_handler() {
    case "${adguardhome_munin_plugin_id}" in
        "blocked")
            adguardhome_munin_fetch_blocked
            ;;
        "clients")
            adguardhome_munin_fetch_clients
            ;;
        "domains")
            adguardhome_munin_fetch_domains
            ;;
        "percent")
            adguardhome_munin_fetch_percent
            ;;
        "processing")
            adguardhome_munin_fetch_processing
            ;;
        "queries")
            adguardhome_munin_fetch_queries
            ;;
        "status")
            adguardhome_munin_fetch_status
            ;;
        "upstreams")
            adguardhome_munin_fetch_upstreams
            ;;
        "upstreams_avg")
            adguardhome_munin_fetch_upstreams_avg
            ;;
        *)
            printf "%s\n" "Error: Cannot fetch for unknown plugin ID '${adguardhome_munin_plugin_id}'." >&2
            exit 1
            ;;
    esac
}

adguardhome_munin_config_handler() {
    case "${adguardhome_munin_plugin_id}" in
        "blocked")
            adguardhome_munin_config_blocked
            ;;
        "clients")
            adguardhome_munin_config_clients
            ;;
        "domains")
            adguardhome_munin_config_domains
            ;;
        "percent")
            adguardhome_munin_config_percent
            ;;
        "processing")
            adguardhome_munin_config_processing
            ;;
        "queries")
            adguardhome_munin_config_queries
            ;;
        "status")
            adguardhome_munin_config_status
            ;;
        "upstreams")
            adguardhome_munin_config_upstreams
            ;;
        "upstreams_avg")
            adguardhome_munin_config_upstreams_avg
            ;;
        *)
            printf "%s\n" "Error: Cannot config for unknown plugin ID '${adguardhome_munin_plugin_id}'." >&2
            exit 1
            ;;
    esac
    if [ "${MUNIN_CAP_DIRTYCONFIG}" = "1" ]; then
        adguardhome_munin_fetch_handler
    fi
}

adguardhome_munin_check_dependencies() {
    plugin_dependencies="curl jq mktemp"
    for plugin_dependency in ${plugin_dependencies}; do
        if ! command -v "${plugin_dependency}" >/dev/null 2>&1; then
            printf "%s\n" "Error: '${plugin_dependency}' is not installed or not in PATH." >&2
            return 1
        fi
    done
}

adguardhome_munin_suggest() {
    for adguardhome_munin_plugin in ${adguardhome_munin_plugins}; do
        printf "%s\n" \
            "${adguardhome_munin_plugin}"
    done
}

adguardhome_munin_autoconf() {
    if ! adguardhome_munin_check_dependencies >/dev/null 2>&1; then
        printf "no\n"
        return
    fi
    if ! command -v AdGuardHome >/dev/null 2>&1 && [ ! -x /opt/AdGuardHome/AdGuardHome ]; then
        printf "no\n"
        return
    fi
    printf "yes\n"
}

adguardhome_munin_auth || {
    printf "%s\n" "Error: Authentication failed. Please check your username and password." >&2
    exit 1
}

case "${1}" in
    ""|"fetch")
        adguardhome_munin_fetch_handler
        ;;
    "config")
        adguardhome_munin_config_handler
        ;;
    "suggest")
        adguardhome_munin_suggest
        ;;
    "autoconf")
        adguardhome_munin_autoconf
        ;;
    *)
        printf "Usage: %s [fetch|config|suggest|autoconf]\n" "${script_path}" >&2
esac

adguardhome_munin_logout || {
    printf "%s\n" "Error: Logout failed." >&2
    exit 1
}
